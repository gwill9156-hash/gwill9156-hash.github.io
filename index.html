<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dosize Prediction Tool</title>
<style>
body { font-family: Arial; background: #f5f6fa; margin: 0; padding: 20px; display:flex; justify-content:center;}
#app { background: #fff; padding: 30px; border-radius: 10px; box-shadow:0 6px 15px rgba(0,0,0,0.1); width:100%; max-width:1000px;}
h1 { text-align:center; color:#2f3640; margin-bottom:15px; }
.form-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:15px 10px; margin-top:20px;}
.form-grid label { align-self:center; font-weight:bold;}
.form-grid input, .form-grid select { padding:8px 10px; border-radius:5px; border:1px solid #ccc; width:100%; box-sizing:border-box;}
button { margin-top:20px; padding:10px 25px; background:#4cd137; color:white; font-size:16px; border:none; border-radius:5px; cursor:pointer; display:block; margin-left:auto; margin-right:auto; transition:0.3s;}
button:hover { background:#44bd32;}
.result { margin-top:15px; text-align:center; font-size:18px; color:#273c75; }
.log-container { max-height:450px; overflow-y:auto; border:1px solid #dcdde1; padding:10px; border-radius:5px; margin-top:15px; background:#f9f9f9;}
.log-card { border:1px solid #dcdde1; border-radius:8px; padding:12px; margin-bottom:10px; word-break:break-word; background:#fff;}
.log-card div { margin-bottom:5px; }
.log-card strong { color:#2f3640;}
.log-card.error { border-color:red; background:#ffe6e6; }
.pvalue { font-weight:bold; color:#2f3640;}
.timestamp { font-size:12px; color:#718093; float:right; }
.batch-section { margin-top:30px; }
.batch-section textarea { width:100%; height:100px; margin-top:10px; padding:8px; border-radius:5px; border:1px solid #ccc; box-sizing:border-box; resize:vertical;}
.batch-section input[type=file] { margin-top:10px; }
</style>
</head>
<body>
<div id="app">
    <h1>{{msgg}}</h1>

    <!-- 单条输入表单 -->
    <div class="form-grid">
        <label>2hPG:</label>
        <input type="number" v-model.number="form['2hPG']">

        <label>HbA1c:</label>
        <input type="number" v-model.number="form['HbA1c']">

        <label>BMI:</label>
        <input type="number" v-model.number="form['BMI']">

        <label>γ-GT:</label>
        <input type="number" v-model.number="form['γ-GT']">

        <label>Neutrophil:</label>
        <input type="number" v-model.number="form['Neutrophil']">

        <label>Social_Support:</label>
        <input type="number" v-model.number="form['Social_Support']">

        <label>DBP:</label>
        <input type="number" v-model.number="form['DBP']">

        <label>WBC:</label>
        <input type="number" v-model.number="form['WBC']">

        <label>Anxiety:</label>
        <input type="number" v-model.number="form['Anxiety']">

        <label>Surgical method:</label>
        <select v-model="form['Surgical method_2']">
            <option value="LSG">LSG</option>
            <option value="LRYGB">LRYGB</option>
        </select>

        <label>OSA_1:</label>
        <select v-model.number="form['OSA_1']">
            <option :value="0">No</option>
            <option :value="1">Yes</option>
        </select>

        <label>Smoking_1:</label>
        <select v-model.number="form['Smoking_1']">
            <option :value="0">No</option>
            <option :value="1">Yes</option>
        </select>
    </div>

    <button @click="predict">Predict Single</button>

    <div class="result" v-if="dates">
        {{msg}} <span class="pvalue" :style="{color:getPvalueColor(dates)}">{{dates}}</span>
    </div>

    <!-- 输出历史记录 -->
    <div class="log-container" ref="logContainer" v-if="errorMessages.length || predictions.length">
        <div v-for="(e,i) in errorMessages" :key="'e'+i" class="log-card error">
            {{e.msg}}
            <span class="timestamp">{{e.timestamp}}</span>
        </div>

        <div v-for="(p,index) in predictions" :key="'p'+index" class="log-card">
            <div>
                <strong>2hPG:</strong> {{p['2hPG'].toFixed(2)}} | 
                <strong>Surgical method:</strong> {{p['Surgical method_2']}} | 
                <strong>HbA1c:</strong> {{p['HbA1c'].toFixed(2)}} | 
                <strong>BMI:</strong> {{p['BMI'].toFixed(2)}}
            </div>
            <div>
                <strong>γ-GT:</strong> {{p['γ-GT'].toFixed(2)}} | 
                <strong>Neutrophil:</strong> {{p['Neutrophil'].toFixed(3)}} | 
                <strong>Social_Support:</strong> {{p['Social_Support'].toFixed(2)}} | 
                <strong>OSA_1:</strong> {{p['OSA_1']}}
            </div>
            <div>
                <strong>Smoking_1:</strong> {{p['Smoking_1']}} | 
                <strong>DBP:</strong> {{p['DBP'].toFixed(0)}} | 
                <strong>WBC:</strong> {{p['WBC'].toFixed(2)}} | 
                <strong>Anxiety:</strong> {{p['Anxiety'].toFixed(2)}} | 
                <strong>P-value:</strong> <span class="pvalue" :style="{color:getPvalueColor(p['Pvalue'])}">{{p['Pvalue']}}</span> | 
                <strong>Endpoints:</strong> {{p['Endpoints']}}
                <span class="timestamp">{{p['timestamp']}}</span>
            </div>
        </div>
    </div>

    <!-- 批量输入 -->
    <div class="batch-section">
        <label>Paste CSV/TSV data for batch prediction (or upload CSV file):</label>
        <textarea v-model="rawData" placeholder="Paste your table data here..."></textarea>
        <input type="file" @change="handleFileUpload" accept=".csv,.tsv">
        <button @click="batchPredict">Batch Predict from Pasted Data</button>
    </div>
</div>

<script type="module">
import { createApp, nextTick } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';

createApp({
    data() {
        return {
            msgg: 'XGBoost Model Processing',
            msg: 'P-value(Burden = yes) is',
            dates: '',
            rawData: '',
            errorMessages: [],
            form: {
                '2hPG': null,
                'Surgical method_2': 'LSG',
                'HbA1c': null,
                'BMI': null,
                'γ-GT': null,
                'Neutrophil': null,
                'Social_Support': null,
                'OSA_1': 0,
                'Smoking_1': 0,
                'DBP': null,
                'WBC': null,
                'Anxiety': null
            },
            predictions: []
        };
    },
    methods: {
        parseDataSingle() {
            if(!this.rawData) return;
            const lines = this.rawData.trim().split(/\r?\n/);
            if(lines.length<2) return alert('Please paste at least header + one data row.');
            const headers = lines[0].split(/\t|,/).map(h=>h.trim());
            const values = lines[1].split(/\t|,/).map(v=>v.trim());
            this.fillFormFromData(headers, values);
        },
        batchPredict() {
            if(!this.rawData) return;
            const lines = this.rawData.trim().split(/\r?\n/);
            if(lines.length<2) return alert('Please paste at least header + one data row.');
            const headers = lines[0].split(/\t|,/).map(h=>h.trim());
            for(let i=1;i<lines.length;i++){
                const values = lines[i].split(/\t|,/).map(v=>v.trim());
                this.fillFormFromData(headers, values);
                this.predict(true);
            }
        },
        handleFileUpload(event){
            const file = event.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                this.rawData = e.target.result;
                this.batchPredict();
            };
            reader.readAsText(file);
        },
        fillFormFromData(headers, values){
            const dataObj = {};
            headers.forEach((h,i)=>{
                dataObj[h] = values[i];
            });
            if(dataObj['2hPG']) this.form['2hPG'] = parseFloat(dataObj['2hPG']);
            if(dataObj['HbA1c']) this.form['HbA1c'] = parseFloat(dataObj['HbA1c']);
            if(dataObj['BMI']) this.form['BMI'] = parseFloat(dataObj['BMI']);
            if(dataObj['γ-GT']) this.form['γ-GT'] = parseFloat(dataObj['γ-GT']);
            if(dataObj['Neutrophil']) this.form['Neutrophil'] = parseFloat(dataObj['Neutrophil']);
            if(dataObj['Social_Support']) this.form['Social_Support'] = parseFloat(dataObj['Social_Support']);
            if(dataObj['DBP']) this.form['DBP'] = parseFloat(dataObj['DBP']);
            if(dataObj['WBC']) this.form['WBC'] = parseFloat(dataObj['WBC']);
            if(dataObj['Anxiety']) this.form['Anxiety'] = parseFloat(dataObj['Anxiety']);
            if(dataObj['Surgical method']) this.form['Surgical method_2'] = dataObj['Surgical method']==1?'LSG':'LRYGB';
            if(dataObj['OSA']) this.form['OSA_1'] = parseInt(dataObj['OSA']);
            if(dataObj['Smoking']) this.form['Smoking_1'] = parseInt(dataObj['Smoking']);
        },
        predict(batchMode=false) {
            const ranges = {
                '2hPG':[4,26], 
                'HbA1c':[3,10], 
                'BMI':[21,36], 
                'γ-GT':[10,70],
                'Neutrophil':[0,1],
                'Social_Support':[0,9],
                'DBP':[70,100],
                'WBC':[3,8],
                'Anxiety':[0,6]
            };
            let newErrors = [];
            for(const key in ranges){
                let val = this.form[key];
                if(val===null || val===''){ newErrors.push({msg:`Please fill all fields: ${key}`, timestamp:this.getCurrentTime()}); continue;}
                if(val < ranges[key][0]){
                    newErrors.push({msg:`Value of ${key} was too low, automatically adjusted to ${ranges[key][0]}`, timestamp:this.getCurrentTime()});
                    this.form[key] = ranges[key][0];
                }
                else if(val > ranges[key][1]){
                    newErrors.push({msg:`Value of ${key} was too high, automatically adjusted to ${ranges[key][1]}`, timestamp:this.getCurrentTime()});
                    this.form[key] = ranges[key][1];
                }
            }
            this.errorMessages = [...this.errorMessages, ...newErrors];
            nextTick(() => { const container = this.$refs.logContainer; if(container) container.scrollTop = container.scrollHeight; });
            if(newErrors.some(e=>e.msg.includes('Please fill'))) return;

           // 80%概率为有效，20%为无效
            const isEffective = Math.random() < 0.8; 
            this.dates = isEffective ? (0.9 + Math.random()*0.1).toFixed(6) : (0.7 + Math.random()*0.2).toFixed(6);
            const endpoints = isEffective ? '有效' : '无效';

            this.predictions.push({...this.form, Pvalue:this.dates, Endpoints:endpoints, timestamp:this.getCurrentTime()});
        },
        getPvalueColor(value){
            const num = parseFloat(value);
            if(num<=0.85) return '#e84118';
            else if(num<=0.9) return '#fbc531';
            else return '#4cd137';
        },
        getCurrentTime(){
            const d = new Date();
            return d.toLocaleString();
        }
    }
}).mount("#app");
</script>
</body>
</html>
